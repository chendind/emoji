function sizereset(a,b,c,d){var e=a/b,f=c/d,g=dy=0;f>=e?(c=a,d=a/f,dy=(b-d)/2):(d=b,c=b*f,g=(a-c)/2);var h={w:c,h:d,dx:g,dy:dy};return h}function getUrl(a){var b;return void 0!=window.createObjectURL?b=window.createObjectURL(a):void 0!=window.URL?b=window.URL.createObjectURL(a):void 0!=window.webkitURL&&(b=window.webkitURL.createObjectURL(a)),b}function getPixelRatio(a){var b=a.backingStorePixelRatio||a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/b}function getimage(a){var b=new Image;return b.src=a.toDataURL("image/png"),$("#savebtn>a").attr("href",a.toDataURL("image/png")),b}function loadingboxshow(){$(".loadingbox").show()}function loadingboxhide(){$(".loadingbox").hide()}var sW=$(window).width(),sH=$(window).height(),_r=.68,position,canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),ratio=1;$("body").height(sH).width(sW),$.each($("#emojibox .scrollbox .longbox"),function(){var a=$(this).children(".emojitable").length;$(this).css("width",100*a+"%").children(".emojitable").css("width",100/a+"%")}),$("#uploadbox").bind("touchend",function(){$("#photofile").trigger("click")}),$("#photofile").bind("change",function(){loadingboxshow(),$(".imagebox").empty(),$("#ctrlbottom.ctrlbottom").removeClass("ctrlstate"),void 0!=position&&context.clearRect(0,0,position.w*ratio,position.h*ratio);var a=this.files[0];if(!/image\/\w+/.test(a.type))return alert("\u4eb2\u53ea\u80fd\u4f20\u56fe\u7247\u54e6"),!1;new FileReader;ImageOrientationFix({image:getUrl(a),onFix:function(a){var b=new Image;b.src=a,b.onload=function(){position=sizereset(sW,$(".innerbox").height(),this.width,this.height),console.log(position.h),this.height=position.h,this.width=position.w,ratio=this.naturalHeight/this.height,$(".innerbox .imagebox").css({width:position.w+"px",height:position.h+"px",left:position.dx+"px"}).append($(this).addClass("userimage")),$(".canvasbox").css({width:position.w+"px",height:position.h+"px",left:position.dx+"px"}),canvas.style.width=position.w+"px",canvas.style.height=position.h+"px",canvas.setAttribute("width",position.w*ratio),canvas.setAttribute("height",position.h*ratio),loadingboxhide(),$("body").hasClass("init")&&$("body").removeClass("init")}}})});var oX,oY,imghtml,isTouchStart=!1,isTouchMove=!1;$(".emojitable div img").bind("touchstart",function(a){isTouchStart=!0,isTouchMove=!1}),$(".emojitable div img").bind("touchmove",function(a){isTouchMove=!0}),$(".emojitable div img").bind("touchend",function(a){if(isTouchStart&&!isTouchMove){$(".emoji").removeClass("adjusting");var b=$(this).attr("src").replace("emoji64","emoji160");imghtml="<img src='"+b+"' class='emoji adjusting' style='left:"+(position.w/2-40)+"px;top:"+(position.h/2-40)+"px;' data-size='1' data-rotate='0' />",$(imghtml).appendTo(".imagebox"),loadingboxshow(),oX=$(this).offset().left,oY=$(this).offset().top,$("#emojibox").removeClass("show"),$(".ctrlbottom").addClass("ctrlstate"),$(".emoji.adjusting")[0].onload=function(){$(".emoji.adjusting").beginAdjust(),loadingboxhide()}}}),$.fn.dragInit=function(){};var emojioX,emojioY,emojitX,emojitY;$(document).on("touchstart",".emoji",function(a){a.preventDefault(),a.stopPropagation(),emojioX=$(this).position().left,emojioY=$(this).position().top,emojitX=a.originalEvent.changedTouches[0].pageX,emojitY=a.originalEvent.changedTouches[0].pageY,$(this).hasClass("adjusting")||$(this).beginAdjust()}),$(document).on("touchmove",".emoji",function(a){a.preventDefault(),a.stopPropagation();var b=emojioX+a.originalEvent.changedTouches[0].pageX-emojitX,c=emojioY+a.originalEvent.changedTouches[0].pageY-emojitY;$(this).css({top:c,left:b})}),$(document).on("touchend",".emoji",function(a){a.preventDefault(),a.stopPropagation(),$(this).hasClass("draging")&&$(this).removeClass("draging")}),$.fn.beginAdjust=function(){$(".emoji").not(this).removeClass("adjusting"),$(this).addClass("adjusting"),$("#ctrlbottom.ctrlbottom").addClass("ctrlstate");var a=$(this).attr("data-size"),b=$(this).attr("data-rotate");$("#sizerange").val(a),$("#rotaterange").val(b),$(this).bindCtrl()},$.fn.bindCtrl=function(){var a=$(this),b=$(this)[0].naturalHeight;$(".range").unbind(".control"),$("#sizerange").bind("touchmove.control",function(){var c=$(this).val();a.css({width:b*c/2+"px"}).attr("data-size",c)}),$("#rotaterange").val(a.attr("data-rotate")).bind("touchmove.control",function(){var b=$(this).val();a.css({transform:"rotate("+b+"deg)","-webkit-transform":"rotate("+b+"deg)"}).attr("data-rotate",b)})},$.fn.removeEmoji=function(){$(this).remove(),$("#ctrlbottom.ctrlbottom").removeClass("ctrlstate")},$("#savebtn").bind("click",function(){loadingboxshow();var a=$(".imagebox img");context.drawImage(a[0],0,0,a[0].naturalWidth,a[0].naturalHeight,0,0,ratio*position.w,ratio*position.h),context.save(),$.each($(".emoji"),function(){var e,a=$(this),b=a.attr("data-rotate")*Math.PI/180,c=a.position().left,d=a.position().top;e=b<Math.PI/2&&b>0||b<-Math.PI/2?.70710678*Math.cos(Math.PI/4-b)*a.outerWidth():-.70710678*Math.cos(b+Math.PI/4)*a.outerWidth(),e=0>e?-e:e;var f=c+e,g=d+e;context.save(),context.translate(ratio*f,ratio*g),context.rotate(b),context.translate(-ratio*f,-ratio*g),context.drawImage(a[0],ratio*(f-.5*a.width()),ratio*(g-.5*a.height()),ratio*a.width(),ratio*a.height()),context.restore()});var b=getimage(canvas);$(b).css({width:position.w,height:position.h}).addClass("veryCenter").appendTo("#composeimagebox"),$(".savebox").show(),loadingboxhide()}),$(".addemojibtn").bind("touchend",function(){$("#emojibox").toggleClass("show")}),$("#removebtn").bind("touchend",function(){$(".emoji.adjusting").removeEmoji()}),$("#resetbtn").bind("touchend",function(){var a="80px";$(".emoji.adjusting").css({width:a,transform:"rotate(0)","-webkit-transform":"rotate(0)"}).attr({"data-size":1,"data-rotate":0}),$("#sizerange").val(1),$("#rotaterange").val(0)}),$("#returnbtn").bind("click",function(){$(".savebox").hide(),$("#composeimagebox").empty()}),$("#copybtn").bind("touchend",function(){var a=$(".emoji.adjusting"),b=a.clone();a.removeClass("adjusting"),b.css({left:a.position().left+10+"px",top:a.position().top+10+"px"}).appendTo(".imagebox"),$("#ctrlbottom").removeClass("ctrlstate")}),$("#indexbtn").bind("touchend",function(){var a=$(".emoji.adjusting");if(!a.is(":last-child")){var b=a.next(".emoji");a.insertAfter(b)}}),$("#firstnewimage").bind("touchend",function(){$("#photofile").trigger("click")}),$(".closebtn").bind("touchend",function(){$(".appinfo").hide()}),$(".info").bind("touchend",function(){$(".appinfo").show()});var tX,dx;$(document).on("touchstart",".longbox",function(a){tX=a.originalEvent.changedTouches[0].pageX}),$(document).on("touchmove",".longbox",function(a){dx=a.originalEvent.changedTouches[0].pageX-tX}),$(document).on("touchend",".longbox",function(a){var b=$(this).attr("data-page")-0,c=$(this).children(".emojitable").length;if(b>=0&&c>b){var d;dx>0&&b>0?d=$(".emojitable[data-index='"+--b+"']",this).position().left:0>dx&&c-1>b&&(d=$(".emojitable[data-index='"+ ++b+"']",this).position().left),$(this).attr("data-page",b).closest(".scrollbox").stop(!0).animate({scrollLeft:d},300,function(){$(this).find(".pagenav a").removeClass("now").filter(":nth-child("+(b+1)+")").addClass("now")})}}),$(".section div").bind("touchend",function(){var a=$(this).attr("data-tab");$("#emojibox").attr("data-showid",a)});